**目标： 使用Ansible编写一个Playbook，自动化部署一个LAMP或LNMP环境，配置虚拟主机，并部署一个简单的PHP网站，使用Ansible模块管理MySQL数据库，创建一个数据库和用户，并导入一个初始的SQL文件，确保所有配置和部署步骤都可以在多台服务器上并行执行。**

## **一 思路：**

在ai上确定思路，可以参考以下步骤：

安装 MySQL；安装 PHP；安装 Nginx；配置相关文件，如 Nginx 配置文件、PHP 配置文件等；启动相关服务，如 MySQL 服务、PHP-FPM 服务、Nginx 服务等；测试 LNMP 环境是否正常运行。

 

## 以下实践

### 1.远程连接成功部署好配置环境（三台）

![img](file:///C:\Users\TTTang\AppData\Local\Temp\ksohtml45168\wps2.jpg) 

 

### 2.创建 lnmp目录，开始编写具体的部署任务

新建文件install.yaml，vi编辑内容。

关闭 SELinux 和防火墙，以确保服务器可以正常访问。

安装指定的软件包，包括 Nginx、MariaDB、MariaDB-server、PHP、php-fpm 和 php-mysql。

启动 MariaDB 服务，并设置为开机自启动。

***\*（语法内容参考 博客园-昭昭木木《ansible-playbook》）\****

![img](file:///C:\Users\TTTang\AppData\Local\Temp\ksohtml45168\wps3.jpg) 

 

### 3.部署一个简单的PHP网站，参考

***\*（b站《WordPress本地环境搭建及安装》）\****

最开始想先从网站入手，选择自由程度高的WordPress做好再进行连接，后面发现还是框架最重要，遂返回建install.yaml。最后选择wordpress-5.0.2-zh_CN.tar直接拉入，发现不用单独搭建。

![img](file:///C:\Users\TTTang\AppData\Local\Temp\ksohtml45168\wps4.png) 

![img](file:///C:\Users\TTTang\AppData\Local\Temp\ksohtml45168\wps5.jpg) 

![img](file:///C:\Users\TTTang\AppData\Local\Temp\ksohtml45168\wps6.jpg) 

![img](file:///C:\Users\TTTang\AppData\Local\Temp\ksohtml45168\wps7.jpg) 

![img](file:///C:\Users\TTTang\AppData\Local\Temp\ksohtml45168\wps8.jpg) 

 

### 4.下载WordPress包，继续编写install

（1）vi编辑www.conf,将user和group的Apache都修改为nginx（确保 PHP-FPM 和 Nginx 能够正确处理 session）

***\*参考csdn《用mysql、php-fpm和nginx搭建博客》\****

 

（2）复制到该目录以便PHP-FPM 运行和处理相关脚本。![img](file:///C:\Users\TTTang\AppData\Local\Temp\ksohtml45168\wps9.jpg)

 

### 5.Nginx 配置

编写vi default.conf

***\*参考博客园《Docker安装Nginx,配置宿主机和容器的工作目录挂载和多个端口监听实例》\****![img](file:///C:\Users\TTTang\AppData\Local\Temp\ksohtml45168\wps10.jpg)

 

 

继续写install，将 Ansible 控制节点上的文件default.conf和拷贝到远程主机的/etc/nginx/conf.d/default.conf路径下。将 Ansible 控制节点上的文件wp-config.php拷贝到远程主机的/usr/share/nginx/html/wordpress/wp-config.php路径下。

![img](file:///C:\Users\TTTang\AppData\Local\Temp\ksohtml45168\wps11.jpg) 

 

### 6.修改wp-conifg.php文件

![img](file:///C:\Users\TTTang\AppData\Local\Temp\ksohtml45168\wps12.jpg) 

 

***\*修改Nginx配置文件参考b站《手动搭建WordPress（centos8）》\****

 

### 7.编辑install.yaml 连接数据库

![img](file:///C:\Users\TTTang\AppData\Local\Temp\ksohtml45168\wps13.jpg) 

![img](file:///C:\Users\TTTang\AppData\Local\Temp\ksohtml45168\wps14.jpg) 

 

## 二、运行改错

![img](file:///C:\Users\TTTang\AppData\Local\Temp\ksohtml45168\wps15.jpg) 

运行失败，ai搜索原因是“unarchive”任务在 192.168.38.131 和 192.168.38.130 上成功改变，但在后续再次执行该任务时，在 192.168.38.130 和 192.168.38.131 上失败，提示找不到指定的“wordpress-5.0.2-zh_CN.tar.gz”文件。

“yum”任务在 192.168.38.130 和 192.168.38.131 上成功，但在 192.168.38.132 上失败，原因是无法获取“epel/x86_64”的元数据。

修改方法：移除原wordpress包，重新下载上载

![img](file:///C:\Users\TTTang\AppData\Local\Temp\ksohtml45168\wps16.jpg) 

 

再次运行出现其他错误

192.168.38.132 上的 yum 任务失败，提示无法获取 epel 仓库的元数据；在 192.168.38.130 和 192.168.38.131 上执行设置 MySQL 密码和创建数据库的 shell 任务时也出现错误，提示数据库已存在或访问被拒绝。

进入etc/sysconfig/network-scripts/ifcfg-ens33检查并无错误;下载repolist再restart；可ping 百度。再次下载nginx。

![img](file:///C:\Users\TTTang\AppData\Local\Temp\ksohtml45168\wps17.jpg) 

 

![img](file:///C:\Users\TTTang\AppData\Local\Temp\ksohtml45168\wps18.jpg) 

再尝试运行，192.168.38.132 节点上执行任务时，与“yum”相关的操作出现了失败。 (AI查错修改)

![img](file:///C:\Users\TTTang\AppData\Local\Temp\ksohtml45168\wps19.jpg) 

 



![img](file:///C:\Users\TTTang\AppData\Local\Temp\ksohtml45168\wps20.jpg) 

另外，通过执行“ls”命令可以看到当前目录下存在“wordpress-5.0.20-zh_CN.tar.gz”，而不是前面提到的“wordpress-5.0.2-zh_CN.tar.gz”，这可能就是导致找不到文件的原因。随后通过“rm -rf”命令删除了这个错误的文件。

多次修改后，192.168.38.132还是出现错误，然后怀疑是虚拟机WEB3的问题遂删除WEB3。![img](file:///C:\Users\TTTang\AppData\Local\Temp\ksohtml45168\wps21.jpg)

 

尝试访问192.168.38.130/wordpress，出现数据库访问出错

![img](file:///C:\Users\TTTang\AppData\Local\Temp\ksohtml45168\wps22.png) 

改错

![img](file:///C:\Users\TTTang\AppData\Local\Temp\ksohtml45168\wps23.jpg) 

修改wp-conifg.php文件，把wordpress改为root

![img](file:///C:\Users\TTTang\AppData\Local\Temp\ksohtml45168\wps24.jpg) 

###  访问成功

目前还有部分报错，但是192.168.38.130和192.168.38.131/wordpress访问成功

![img](file:///C:\Users\TTTang\AppData\Local\Temp\ksohtml45168\wps25.jpg) 

![img](file:///C:\Users\TTTang\AppData\Local\Temp\ksohtml45168\wps26.jpg) 

 

 

![img](file:///C:\Users\TTTang\AppData\Local\Temp\ksohtml45168\wps27.jpg) 

 

### 项目最终结构

![img](file:///C:\Users\TTTang\AppData\Local\Temp\ksohtml45168\wps28.jpg) 

Github中有两个压缩包上传超限制

（以上部分是部署过程中截图，大部分为部署结束后补充。）